---
import DocumentLayout from "../components/layouts/document-layout.astro";
import { Input } from "../components/form/input";
import { GridSelect } from "../components/form/grid_select";
import PhotoChico from "../../public/photo_chico.jpeg";
import { Image } from "astro:assets";
import { firestore } from "../lib/firebase-server";
import WhatsappSvgrepoComSvg from "../components/icons/whatsapp-svgrepo-com.svg.astro";
import MercadoPagoLogoSvg from "../components/icons/mercado-pago-logo.svg.astro";

const docs = await firestore.collection("raffles").get();
const data: any[] = docs.docs.map((snap) => snap.data());
---

<script>
    import { logEvent } from "firebase/analytics";
    import { analytics } from "../lib/firebase";
    logEvent(analytics, "page_view");
</script>

<script>
    const choiceForm = document.querySelector("#choice");
    const btns = document.querySelectorAll("[x-wa-send]");

    if (choiceForm instanceof HTMLFormElement) {
        for (const btn of btns) {
            if (btn instanceof HTMLButtonElement) {
                btn.addEventListener("click", () => {
                    const textTemplate = btn.dataset.textTemplate;
                    const phone = btn.dataset.phone;
                    const baseHref = btn.dataset.baseHref;
                    const formData = new FormData(choiceForm);
                    const numbers = formData
                        .getAll("raffle_number")
                        .map((e) => Number(e.toString()) + 1);

                    const u = new URL(baseHref);
                    u.pathname = `/${phone}`;

                    u.searchParams.set(
                        "text",
                        textTemplate.replace(
                            "{numbers}",
                            new Intl.ListFormat("es-cl").format(
                                numbers.map((e) => e.toString()),
                            ),
                        ),
                    );

                    console.log({ u, phone, textTemplate, baseHref, numbers });

                    window.open(u, "black");
                });
            }
        }
    }
</script>

<DocumentLayout title="Rifa a beneficio Chico">
    <div class="container m-auto p-4">
        <form id="choice" method="post" action="/pay" autocomplete="on">
            <div class="flex justify-center py-4">
                <Image
                    class="rounded shadow-md"
                    src={PhotoChico}
                    alt="Photo Chico"
                    width={150}
                    height={150}
                    transition:name="photo_chico"
                />
            </div>
            <h1 class="text-2xl font-bold pb-2">
                ¬°Bienvenido a la Rifa Solidaria en Apoyo a Chico! üêæ
            </h1>
            <p class="pb-2">
                Cada n√∫mero que elijas no solo te da la oportunidad de ganar un
                emocionante premio, sino que tambi√©n contribuye directamente a
                brindarle amor y atenci√≥n a Chico. Tu generosidad y apoyo son
                invaluables para su bienestar.
            </p>
            <p class="pb-2">
                Selecciona tu n√∫mero de la suerte entre los disponibles y, con
                un poco de suerte, podr√≠as ser el afortunado ganador. ¬°Gracias
                por ser parte de esta noble causa!
            </p>
            <div
                class="[&>div>input]:border
                       [&>div>input]:rounded
                       [&>div>input]:w-full
                       [&>div>input]:px-4
                       [&>div>input]:py-4
                       space-y-4"
            >
                <div>
                    <GridSelect total={100} values={data} />
                </div>
                <div>
                    <label for="phone_number">Numero de tel√©fono</label>
                    <p class="text-gray-500">
                        Por favor, proporciona tu n√∫mero de tel√©fono a
                        continuaci√≥n. No te preocupes, solo lo usaremos para
                        ponernos en contacto contigo si eres el afortunado
                        ganador.
                    </p>
                    <Input
                        id="phone_number"
                        name="phone_number"
                        type="tel"
                        placeholder="123456789"
                        autoComplete="tel-country-code"
                        required
                    />
                </div>
                <div class="flex gap-4">
                    <button
                        type="submit"
                        class="px-4 py-2 rounded bg-blue-400 text-white inline-flex space-x-2 [&>span]:flex-1
                        transition
                        shadow
                        hover:shadow-md
                        focus:shadow-inner
                        [&>svg]:flex-none
                        [&>svg]:h-6
                        "
                    >
                        <span>Ir a Pagar</span>
                        <MercadoPagoLogoSvg />
                    </button>
                    <button
                        type="button"
                        x-wa-send
                        class="px-4 py-2 inline-flex rounded bg-green-400 text-white
                                space-x-2
                                transition
                                shadow
                                hover:shadow-md
                                focus:shadow-inner
                                [&>span]:flex-1
                                [&>svg]:flex-none
                                [&>svg]:fill-white
                                [&>svg]:h-6"
                        data-base-href="https://wa.me"
                        data-phone="56963187228"
                        data-text-template="Hola, quiero comprar los numeros {numbers}"
                    >
                        <span>Ir a donar directo</span>
                        <WhatsappSvgrepoComSvg />
                    </button>
                </div>
            </div>
        </form>
    </div>
</DocumentLayout>
